<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yakuza – Logs</title>
  <meta name="description" content="Sistema de logs Yakuza. Acceso exclusivo con Discord.">
  <style>
    :root{
      /* Young Yakuza */
      --yy-green:#27f198;   /* principal */
      --yy-lilac:#9e8ced;   /* acento */
      /* Base UI */
      --bg:#0a0a0e;         /* fondo */
      --bg-2:#0c0c12;
      --panel:#12121a;      /* tarjetas */
      --bd:#222334;         /* bordes */
      --text:#e7e7e9;       /* texto */
      --muted:#a3a7b3;      /* texto secundario */
      --ok:#27f198;         /* ok */
      --alert:#ef4444;      /* alerta */
      --radius:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
      color:var(--text);
      background:linear-gradient(180deg,var(--bg) 0%, var(--bg-2) 60%, var(--bg) 100%);
    }
    a{color:var(--yy-green);text-decoration:none}
    .container{max-width:1000px;margin:0 auto;padding:24px}
    .card{
      background:var(--panel);
      border:1px solid var(--bd);
      border-radius:var(--radius);
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35)
    }
    h1{font-size:clamp(20px,4vw,32px);margin:0 0 8px}
    h2{font-size:20px;margin:0 0 12px}
    .muted{color:var(--muted)}
    .hidden{display:none}

    .btn{
      cursor:pointer;display:inline-flex;align-items:center;gap:10px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--bd);
      background:#121221;color:var(--text)
    }
    /* ÚNICA regla válida con paleta YY */
    .btn.primary{
      background:linear-gradient(90deg, var(--yy-lilac) 0%, var(--yy-green) 100%);
      border:none;
    }

    input,select,textarea{
      width:100%;background:#0f0f15;border:1px solid var(--bd);color:var(--text);
      border-radius:10px;padding:12px 14px;outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:#6ea8ff}
    .row{display:grid;gap:14px}
    @media (min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}

    .pill{display:inline-flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;background:#101019}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--bd);background:#0f0f18}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}

    .table{width:100%;border-collapse:collapse;font-size:14px}
    .table th,.table td{padding:10px;border-bottom:1px solid var(--bd)}
    .avatar{width:24px;height:24px;border-radius:999px;object-fit:cover;vertical-align:middle;margin-right:6px}

    .toast{position:fixed;bottom:18px;right:18px;background:#121226;border:1px solid var(--bd);padding:12px 14px;border-radius:12px}

    /* Grid para tarjetas KPI del resumen */
    .yy-grid-cards{
      display:grid;gap:12px;
      grid-template-columns: repeat( auto-fit, minmax(190px, 1fr) );
    }
    .kpi{
      background:linear-gradient(180deg,#12121a 0%, #101018 100%);
      border:1px solid var(--bd);
      border-radius:var(--radius);
      padding:14px;
    }
    .kpi .kpi-label{font-size:13px;color:var(--muted)}
    .kpi .kpi-value{font-size:28px;font-weight:700;margin-top:4px}
    .kpi .kpi-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .kpi.req .kpi-value{color:var(--yy-green)}
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="card" style="margin-bottom:16px;display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>
        <h1>Yakuza – Logs</h1>
        <div class="muted">Acceso solo con Discord. Registro centralizado de Almacenes, Venta de Meta, Encargos, Crafteo y Tiradas.</div>
      </div>
      <div id="authBox" class="flex">
        <img id="avatar" class="avatar hidden" alt="">
        <span id="whoami" class="pill hidden"></span>
        <button id="btnSignOut" class="btn hidden">Salir</button>
      </div>
    </div>

    <!-- Auth card (Discord only) -->
    <div id="authCard" class="card">
      <h2>Ingresá con Discord</h2>
      <p class="muted">Se solicitará tu cuenta de Discord para identificarte.</p>
      <button id="btnDiscord" class="btn primary">Entrar con Discord</button>
    </div>

    <!-- App -->
    <div id="app" class="hidden">
      <!-- ====== RESUMEN SEMANAL ====== -->
      <div class="card" style="margin-top:16px">
        <div class="flex">
          <h2>Resumen semanal</h2>
          <div class="right flex">
            <input id="weekInput" type="week">
            <button id="btnPrevWeek" class="btn">◀ Semana anterior</button>
            <button id="btnNextWeek" class="btn">Semana siguiente ▶</button>
            <button id="btnThisWeek" class="btn">Esta semana</button>
            <button id="btnExportWeeklyCSV" class="btn">Exportar CSV</button>
          </div>
        </div>
        <div id="weeklyGrid" class="yy-grid-cards" style="margin-top:12px"></div>
        <div class="muted" style="margin-top:8px">
          * En categorías con cantidad (Venta de Meta, Crafteo Armas, Tiradas Meta) se muestra el <strong>total</strong>. En el resto, la <strong>cantidad de acciones</strong>.
        </div>
      </div>

      <!-- ====== NUEVO LOG ====== -->
      <div class="card" style="margin-top:16px">
        <h2>Nuevo log</h2>
        <div class="row">
          <div>
            <label>Participantes (separados por coma)</label>
            <input id="participants" placeholder="Mikaro, Yoshi, Itadura">
          </div>
          <div>
            <label>Categoría</label>
            <select id="category">
              <option value="almacenes">Almacenes</option>
              <option value="venta_meta">Venta de Meta</option>
              <option value="encargos_armas">Encargos Armas</option>
              <option value="crafteo_armas">Crafteo / Compra de Armas</option>
              <option value="encargos_fleccas">Encargos / Fleccas</option>
              <option value="materiales_bonos">Materiales / Bonos</option>
              <option value="encargos_quimicos">Encargos Químicos</option>
              <option value="tiradas_meta">Tiradas Metanfetamina</option>
            </select>
          </div>
          <div id="amountWrap" class="hidden">
            <label>Cantidad (número)</label>
            <input id="amount" type="number" min="0" step="1" placeholder="Ej: 25">
          </div>
          <div>
            <label>Notas (opcional)</label>
            <textarea id="notes" rows="3" placeholder="Detalles adicionales"></textarea>
          </div>
          <div class="flex">
            <span id="amountHint" class="tag hidden">Esta categoría requiere cantidad</span>
            <button id="btnSubmit" class="btn primary right">Guardar log</button>
          </div>
        </div>
      </div>

      <!-- ====== LISTADO ====== -->
      <div class="card" style="margin-top:16px">
        <div class="flex">
          <h2>Registros recientes</h2>
          <div class="right flex">
            <select id="filterCat">
              <option value="">Todas</option>
              <option value="almacenes">Almacenes</option>
              <option value="venta_meta">Venta de Meta</option>
              <option value="encargos_armas">Encargos Armas</option>
              <option value="crafteo_armas">Crafteo / Compra de Armas</option>
              <option value="encargos_fleccas">Encargos / Fleccas</option>
              <option value="materiales_bonos">Materiales / Bonos</option>
              <option value="encargos_quimicos">Encargos Químicos</option>
              <option value="tiradas_meta">Tiradas Metanfetamina</option>
            </select>
            <button id="btnReload" class="btn">Actualizar</button>
            <button id="btnCSV" class="btn">Exportar CSV</button>
          </div>
        </div>
        <div style="overflow:auto;margin-top:8px">
          <table class="table" id="logsTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Usuario</th>
                <th>Categoría</th>
                <th>Participantes</th>
                <th>Cantidad</th>
                <th>Notas</th>
              </tr>
            </thead>
            <tbody><!-- rows --></tbody>
          </table>
        </div>
      </div>
    </div> <!-- /#app -->
  </div> <!-- /.container -->

  <div id="toast" class="toast hidden"></div>

  <script type="module">
    // ========= CONFIG & CLIENT =========
    const SUPABASE_URL  = "https://dxohxpjeymoenqnvmqko.supabase.co"; // <-- reemplazar
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4b2h4cGpleW1vZW5xbnZtcWtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDQ1MjcsImV4cCI6MjA3MjYyMDUyN30.lIDbq0OzEghpqtXCaRIbU33bcMq_l77zFAWTbrB0myE";                  // <-- reemplazar
    const REDIRECT_TO   = location.origin + location.pathname;   // soporta GitHub Pages en subpath

    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, { auth:{ persistSession:true } });

    // ========= CATEGORÍAS =========
    const REQUIRES_AMOUNT = new Set(['venta_meta','crafteo_armas','tiradas_meta']);
    const CAT_LABEL = {
      almacenes:'Almacenes',
      venta_meta:'Venta de Meta',
      encargos_armas:'Encargos Armas',
      crafteo_armas:'Crafteo / Compra de Armas',
      encargos_fleccas:'Encargos / Fleccas',
      materiales_bonos:'Materiales / Bonos',
      encargos_quimicos:'Encargos Químicos',
      tiradas_meta:'Tiradas Metanfetamina'
    };

    // ========= REFS UI =========
    const authCard   = document.getElementById('authCard');
    const app        = document.getElementById('app');
    const whoami     = document.getElementById('whoami');
    const avatarImg  = document.getElementById('avatar');
    const btnSignOut = document.getElementById('btnSignOut');
    const btnDiscord = document.getElementById('btnDiscord');

    const participants = document.getElementById('participants');
    const category     = document.getElementById('category');
    const amountWrap   = document.getElementById('amountWrap');
    const amount       = document.getElementById('amount');
    const amountHint   = document.getElementById('amountHint');
    const notes        = document.getElementById('notes');
    const btnSubmit    = document.getElementById('btnSubmit');

    const filterCat    = document.getElementById('filterCat');
    const btnReload    = document.getElementById('btnReload');
    const btnCSV       = document.getElementById('btnCSV');
    const logsTable    = document.querySelector('#logsTable tbody');

    // Resumen semanal
    const weekInput = document.getElementById('weekInput');
    const btnPrevWeek = document.getElementById('btnPrevWeek');
    const btnNextWeek = document.getElementById('btnNextWeek');
    const btnThisWeek = document.getElementById('btnThisWeek');
    const weeklyGrid = document.getElementById('weeklyGrid');
    const btnExportWeeklyCSV = document.getElementById('btnExportWeeklyCSV');

    const toastEl = document.getElementById('toast');
    function showToast(msg){ toastEl.textContent=msg; toastEl.classList.remove('hidden'); setTimeout(()=>toastEl.classList.add('hidden'),2200); }

    // ========= AUTH (Discord only) =========
    btnDiscord.onclick = async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'discord',
        options: { redirectTo: REDIRECT_TO, scopes: 'identify email' }
      });
      if (error) showToast(error.message);
    };
    btnSignOut.onclick = async () => { await supabase.auth.signOut(); refreshSession(); };

    async function ensureProfile(user){
      const m = user.user_metadata || {};
      const nick   = (m.global_name || m.full_name || m.name || m.user_name || 'usuario').toString();
      const avatar = m.avatar_url || m.picture || null;
      const { error } = await supabase.from('profiles')
        .upsert({ id: user.id, username: nick.toLowerCase(), avatar_url: avatar }, { onConflict: 'id' });
      if (error) console.warn('profiles upsert error', error);
      return { nick, avatar };
    }

    async function refreshSession(){
      const { data:{ user } } = await supabase.auth.getUser();
      if (user){
        const { nick, avatar } = await ensureProfile(user);
        whoami.textContent = `Conectado: ${nick}`;
        whoami.classList.remove('hidden');
        if (avatar){ avatarImg.src = avatar; avatarImg.classList.remove('hidden'); }
        btnSignOut.classList.remove('hidden');
        authCard.classList.add('hidden');
        app.classList.remove('hidden');
        await loadLogs();
        bootWeekly(); // pinta el resumen
      }else{
        authCard.classList.remove('hidden');
        app.classList.add('hidden');
        whoami.classList.add('hidden');
        avatarImg.classList.add('hidden');
        btnSignOut.classList.add('hidden');
      }
    }

    // ========= FORM LOG =========
    function updateAmountVisibility(){
      const need = REQUIRES_AMOUNT.has(category.value);
      amountWrap.classList.toggle('hidden', !need);
      amountHint.classList.toggle('hidden', !need);
    }
    category.addEventListener('change', updateAmountVisibility);
    updateAmountVisibility();

    btnSubmit.onclick = async () => {
      const parts = participants.value.split(',').map(s=>s.trim()).filter(Boolean);
      if (parts.length===0) return showToast('Agrega al menos un participante');

      const { data:{ user } } = await supabase.auth.getUser();
      if (!user) return showToast('No autenticado');

      const cat = category.value;
      const need = REQUIRES_AMOUNT.has(cat);
      const amt = amount.value ? Number(amount.value) : null;
      if (need && !(amt>=0)) return showToast('La cantidad es obligatoria');

      const payload = {
        user_id: user.id,
        participants: parts,
        category: cat,
        amount: need ? amt : null,
        notes: notes.value || null
      };

      const { error } = await supabase.from('logs').insert(payload);
      if (error) return showToast(error.message);

      participants.value=''; amount.value=''; notes.value='';
      showToast('Log guardado');
      await loadLogs(); bootWeekly();
    };

    // ========= LISTADO =========
    async function loadLogs(){
      let query = supabase.from('logs').select(`
        id, created_at, user_id, participants, category, amount, notes,
        profiles!inner(username, avatar_url)
      `).order('created_at',{ascending:false}).limit(200);

      if (filterCat.value) query = query.eq('category', filterCat.value);

      const { data, error } = await query;
      if (error) return showToast(error.message);
      renderTable(data||[]);
    }

    function renderTable(rows){
      logsTable.innerHTML = rows.map(r=>{
        const date = new Date(r.created_at).toLocaleString();
        const who  = r.profiles?.username || '—';
        const ava  = r.profiles?.avatar_url ? `<img class="avatar" src="${r.profiles.avatar_url}" alt="">` : '';
        const parts= (r.participants||[]).join(', ');
        const amt  = (r.amount ?? '') === '' ? '—' : r.amount;
        const cat  = (CAT_LABEL[r.category] || r.category).replace('_',' ');
        const safe = (s)=> (s||'').replaceAll('<','&lt;').replaceAll('>','&gt;');
        return `<tr>
          <td>${date}</td>
          <td>${ava}${safe(who)}</td>
          <td><span class="tag">${safe(cat)}</span></td>
          <td>${safe(parts)}</td>
          <td>${amt}</td>
          <td>${safe(r.notes||'')}</td>
        </tr>`;
      }).join('');
    }

    btnReload.onclick = loadLogs;
    filterCat.onchange = loadLogs;

    btnCSV.onclick = async () => {
      let query = supabase.from('logs').select('*').order('created_at',{ascending:false}).limit(2000);
      if (filterCat.value) query = query.eq('category', filterCat.value);
      const { data, error } = await query;
      if (error) return showToast(error.message);
      const header = ["created_at","category","participants","amount","notes","user_id"];
      const csv = [header.join(",")]
        .concat((data||[]).map(r=>[
          r.created_at,
          r.category,
          `"${(r.participants||[]).join(' | ')}"`,
          r.amount ?? "",
          `"${(r.notes||"").replaceAll('"','""')}"`,
          r.user_id
        ].join(",")))
        .join("\n");
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:'logs.csv' });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    // ========= RESUMEN SEMANAL =========
    function getWeekStart(date = new Date()){
      const d = new Date(date);
      const day = d.getDay();               // 0=Dom, 1=Lun
      const diff = (day === 0 ? -6 : 1 - day);
      d.setHours(0,0,0,0);
      d.setDate(d.getDate() + diff);
      return d;
    }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function toISODate(d){ return d.toISOString(); }

    function setWeekInputFromDate(d){
      const tgt = getWeekStart(d);
      const year = new Intl.DateTimeFormat('en-CA',{year:'numeric'}).format(tgt);
      const temp = new Date(Date.UTC(tgt.getFullYear(),0,4));
      const week1 = getWeekStart(temp);
      const diff = (tgt - week1) / (1000*60*60*24*7) + 1;
      const weekNo = String(Math.round(diff)).padStart(2,'0');
      weekInput.value = `${year}-W${weekNo}`;
    }

    function getWeekRangeFromInput(){
      if (!weekInput.value){
        const start = getWeekStart(new Date());
        return { start, end: addDays(start,7) };
      }
      const [y, w] = weekInput.value.split('-W').map(Number);
      const jan4 = new Date(Date.UTC(y,0,4));
      const weekStart = getWeekStart(jan4);
      const start = new Date(weekStart); start.setUTCDate(weekStart.getUTCDate() + (w-1)*7);
      return { start: new Date(start), end: addDays(start,7) };
    }

    async function loadWeeklySummary(){
      const { start, end } = getWeekRangeFromInput();
      let { data, error } = await supabase.from('logs')
        .select('category, amount, created_at')
        .gte('created_at', toISODate(start))
        .lt('created_at',  toISODate(end));
      if (error){ showToast(error.message); return; }

      const summary = {};
      for (const cat of Object.keys(CAT_LABEL)) summary[cat] = { count:0, amountSum:0 };

      for (const r of (data||[])){
        const cat = r.category;
        if (REQUIRES_AMOUNT.has(cat)) summary[cat].amountSum += Number(r.amount || 0);
        else summary[cat].count += 1;
      }

      weeklyGrid.innerHTML = Object.entries(summary).map(([cat, vals])=>{
        const label = CAT_LABEL[cat] || cat;
        const requires = REQUIRES_AMOUNT.has(cat);
        const value = requires ? (vals.amountSum || 0) : (vals.count || 0);
        const sub   = requires ? 'Total semanal' : 'Acciones esta semana';
        const cls   = requires ? 'kpi req' : 'kpi';
        return `
          <div class="${cls}">
            <div class="kpi-label">${label}</div>
            <div class="kpi-value">${value}</div>
            <div class="kpi-sub">${sub}</div>
          </div>
        `;
      }).join('');
    }

    btnThisWeek.onclick = ()=>{ setWeekInputFromDate(new Date()); loadWeeklySummary(); };
    btnPrevWeek.onclick = ()=>{ const r=getWeekRangeFromInput(); setWeekInputFromDate(addDays(r.start,-7)); loadWeeklySummary(); };
    btnNextWeek.onclick = ()=>{ const r=getWeekRangeFromInput(); setWeekInputFromDate(addDays(r.start,7));  loadWeeklySummary(); };
    weekInput.onchange  = loadWeeklySummary;

    btnExportWeeklyCSV.onclick = async ()=>{
      const { start, end } = getWeekRangeFromInput();
      let { data, error } = await supabase.from('logs')
        .select('created_at, category, participants, amount, notes, user_id')
        .gte('created_at', toISODate(start))
        .lt('created_at',  toISODate(end));
      if (error){ showToast(error.message); return; }

      const header = ["created_at","category","participants","amount","notes","user_id"];
      const csv = [header.join(",")]
        .concat((data||[]).map(r=>[
          r.created_at,
          r.category,
          `"${(r.participants||[]).join(' | ')}"`,
          r.amount ?? "",
          `"${(r.notes||"").replaceAll('"','""')}"`,
          r.user_id
        ].join(",")))
        .join("\n");
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url  = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href:url, download:`logs_semana_${new Date().toISOString().slice(0,10)}.csv` });
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    };

    function bootWeekly(){ setWeekInputFromDate(new Date()); loadWeeklySummary(); }

    supabase.auth.onAuthStateChange(()=>refreshSession());
    refreshSession();
  </script>
</body>
</html>
